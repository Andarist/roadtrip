{"version":3,"file":"roadtrip.js","sources":["../../../src/roadtrip.js","../../../src/utils/watchLinks.js","../../../src/Route.js"],"sourcesContent":["import Route from './Route';\nimport watchLinks from './utils/watchLinks';\n\n// Enables HTML5-History-API polyfill: https://github.com/devote/HTML5-History-API\nvar location = window.history.location || window.location;\n\nfunction Roadtrip () {\n\tthis.routes = [];\n\n\tthis.currentData = {};\n\tthis.currentRoute = {\n\t\tenter: () => roadtrip.Promise.resolve(),\n\t\tleave: () => roadtrip.Promise.resolve()\n\t};\n\n\tthis.base = '';\n\n\twatchLinks( href => this.goto( href ) );\n\n\twindow.addEventListener( 'popstate', () => {\n\t\tthis.goto( location.href );\n\t}, false );\n}\n\nRoadtrip.prototype = {\n\tadd ( path, options ) {\n\t\tthis.routes.push( new Route( path, options ) );\n\t\treturn this;\n\t},\n\n\tstart () {\n\t\treturn this.goto( location.href, { replaceState: true });\n\t},\n\n\tgoto ( href, options = {} ) {\n\t\tlet target;\n\t\tlet promise = new roadtrip.Promise( ( fulfil, reject ) => {\n\t\t\ttarget = this._target = { href, options, fulfil, reject };\n\t\t});\n\n\t\tif ( this.isTransitioning ) {\n\t\t\treturn promise;\n\t\t}\n\n\t\tthis._goto( target );\n\t\treturn promise;\n\t},\n\n\t_goto ( target ) {\n\t\tlet i, len = this.routes.length;\n\t\tlet newRoute, data;\n\n\t\tfor ( i = 0; i < len; i += 1 ) {\n\t\t\tlet route = this.routes[i];\n\t\t\tdata = route.exec( target.href );\n\n\t\t\tif ( data ) {\n\t\t\t\tnewRoute = route;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\t// TODO handle changes to query string/hashbang\n\t\tif ( !newRoute || newRoute === this.currentRoute ) return roadtrip.Promise.resolve();\n\n\t\tthis.isTransitioning = true;\n\n\t\troadtrip.Promise.all([\n\t\t\tthis.currentRoute.leave( this.currentData, data ),\n\t\t\tnewRoute.beforeenter( data, this.currentData )\n\t\t])\n\t\t\t.then( () => newRoute.enter( data, this.currentData ) )\n\t\t\t.then( () => {\n\t\t\t\tthis.isTransitioning = false;\n\n\t\t\t\t// if the user navigated while the transition was taking\n\t\t\t\t// place, we need to do it all again\n\t\t\t\tif ( this._target !== target ) {\n\t\t\t\t\tthis._goto( this._target );\n\t\t\t\t}\n\n\t\t\t\telse {\n\t\t\t\t\ttarget.fulfil();\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch( target.reject );\n\n\t\tthis.currentRoute = newRoute;\n\t\tthis.currentData = data;\n\n\t\thistory[ target.options.replaceState ? 'replaceState' : 'pushState' ]( {}, '', target.href );\n\t}\n};\n\nlet roadtrip = new Roadtrip();\nroadtrip.Promise = window.Promise;\n\nexport default roadtrip;\n","import roadtrip from '../roadtrip';\n\n// Adapted from https://github.com/visionmedia/page.js\n// MIT license https://github.com/visionmedia/page.js#license\n\nexport default function watchLinks ( callback ) {\n\twindow.addEventListener( 'click', handler, false );\n\twindow.addEventListener( 'touchstart', handler, false );\n\n\tfunction handler ( event ) {\n\t\tif ( which( event ) !== 1 ) return;\n\t\tif ( event.metaKey || event.ctrlKey || event.shiftKey ) return;\n\t\tif ( event.defaultPrevented ) return;\n\n\t\t// ensure target is a link\n\t\tlet el = event.target;\n\t\twhile ( el && el.nodeName !== 'A' ) {\n\t\t\tel = el.parentNode;\n\t\t}\n\n\t\tif ( !el || el.nodeName !== 'A' ) return;\n\n\t\t// Ignore if tag has\n\t\t// 1. 'download' attribute\n\t\t// 2. rel='external' attribute\n\t\tif ( el.hasAttribute('download') || el.getAttribute('rel') === 'external' ) return;\n\n\t\t// ensure non-hash for the same path\n\t\tif ( el.pathname === location.pathname && ( el.hash ) ) return;\n\n\t\tlet link = el.getAttribute( 'href' );\n\n\t\t// Check for mailto: in the href\n\t\tif ( ~link.indexOf( 'mailto:' ) ) return;\n\n\t\t// check target\n\t\tif ( el.target ) return;\n\n\t\t// x-origin\n\t\tif ( !sameOrigin( el.href ) ) return;\n\n\t\t// rebuild path\n\t\tvar path = el.pathname + el.search + ( el.hash || '' );\n\n\t\t// strip leading '/[drive letter]:' on NW.js on Windows\n\t\tif ( typeof process !== 'undefined' && path.match( /^\\/[a-zA-Z]:\\// ) ) {\n\t\t\tpath = path.replace( /^\\/[a-zA-Z]:\\//, '/' );\n\t\t}\n\n\t\t// same page\n\t\tvar orig = path;\n\n\t\tif ( path.indexOf( roadtrip.base ) === 0 ) {\n\t\t\tpath = path.substr( roadtrip.base.length );\n\t\t}\n\n\t\tif ( roadtrip.base && orig === path ) return;\n\n\t\tevent.preventDefault();\n\t\tcallback( orig );\n\t}\n}\n\nfunction which( event ) {\n\tevent = event || window.event;\n\treturn event.which === null ? event.button : event.which;\n}\n\nfunction sameOrigin ( href ) {\n\tvar origin = location.protocol + '//' + location.hostname;\n\tif ( location.port ) origin += ':' + location.port;\n\n\treturn ( href && ( href.indexOf( origin ) === 0 ) );\n}\n","import roadtrip from './roadtrip';\n\nconst a = document.createElement( 'a' );\nconst QUERYPAIR_REGEX = /^([\\w\\-]+)(?:=([^&]*))?$/;\nconst HANDLERS = [ 'beforeenter', 'enter', 'leave' ];\n\nlet isInitial = true;\n\nfunction RouteData ({ route, pathname, params, query, isInitial }) {\n\tthis.pathname = pathname;\n\tthis.params = params;\n\tthis.query = query;\n\tthis.isInitial = isInitial;\n\n\tthis._route = route;\n\n\tisInitial = false;\n}\n\nRouteData.prototype = {\n\tmatches ( href ) {\n\t\treturn this._route.matches( href );\n\t}\n}\n\nexport default function Route ( path, options ) {\n\t// strip leading slash\n\tif ( path[0] === '/' ) {\n\t\tpath = path.slice( 1 );\n\t}\n\n\tthis.path = path;\n\tthis.segments = path.split( '/' );\n\n\tif ( typeof options === 'function' ) {\n\t\toptions = {\n\t\t\tenter: options\n\t\t};\n\t}\n\n\tHANDLERS.forEach( handler => {\n\t\tthis[ handler ] = ( route, other ) => {\n\t\t\tlet value;\n\n\t\t\tif ( options[ handler ] ) {\n\t\t\t\tvalue = options[ handler ]( route, other );\n\t\t\t}\n\n\t\t\treturn roadtrip.Promise.resolve( value );\n\t\t};\n\t});\n}\n\nRoute.prototype = {\n\tmatches ( href ) {\n\t\ta.href = href;\n\n\t\tlet pathname = a.pathname.slice( 1 );\n\t\tlet segments = pathname.split( '/' );\n\n\t\treturn segmentsMatch( segments, this.segments );\n\t},\n\n\texec ( href ) {\n\t\ta.href = href;\n\n\t\tlet pathname = a.pathname.slice( 1 );\n\t\tlet search = a.search.slice( 1 );\n\n\t\tlet segments = pathname.split( '/' );\n\n\t\tif ( segments.length !== this.segments.length ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tlet params = {}, i;\n\n\t\tfor ( i = 0; i < segments.length; i += 1 ) {\n\t\t\tlet segment = segments[i];\n\t\t\tlet toMatch = this.segments[i];\n\n\t\t\tif ( toMatch[0] === ':' ) {\n\t\t\t\tparams[ toMatch.slice( 1 ) ] = segment;\n\t\t\t}\n\n\t\t\telse if ( segment !== toMatch ) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\tlet query = {};\n\t\tlet queryPairs = search.split( '&' );\n\n\t\tfor ( i = 0; i < queryPairs.length; i += 1 ) {\n\t\t\tlet match = QUERYPAIR_REGEX.exec( queryPairs[i] );\n\n\t\t\tif ( match ) {\n\t\t\t\tlet key = match[1], value = decodeURIComponent( match[2] );\n\n\t\t\t\tif ( query.hasOwnProperty( key ) ) {\n\t\t\t\t\tif ( typeof query[ key ] !== 'object' ) {\n\t\t\t\t\t\tquery[ key ] = [ query[ key ] ];\n\t\t\t\t\t}\n\n\t\t\t\t\tquery[ key ].push( value );\n\t\t\t\t}\n\n\t\t\t\telse {\n\t\t\t\t\tquery[ key ] = value;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn new RouteData({ route: this, pathname, params, query, isInitial });\n\t}\n};\n\nfunction segmentsMatch ( a, b ) {\n\tif ( a.length !== b.length ) return;\n\n\tlet i = a.length;\n\twhile ( i-- ) {\n\t\treturn b[0] === ':' || a === b;\n\t}\n}\n"],"names":[],"mappings":"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"}